name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  bazel:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect devcontainer changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            devcontainer:
              - '.devcontainer/**'

      - name: Resolve image tag and prebuilt availability
        id: prep
        run: |
          mapfile -t files < <(git ls-files '.devcontainer/**' | sort)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No files found under .devcontainer" >&2
            exit 1
          fi

          tmpfile=$(mktemp)
          for file in "${files[@]}"; do
            printf '%s\n' "$file" >> "$tmpfile"
            sha256sum "$file" | cut -d' ' -f1 >> "$tmpfile"
          done

          hash=$(sha256sum "$tmpfile" | cut -d' ' -f1)
          rm -f "$tmpfile"

          short_hash=${hash:0:16}
          image_tag=dc-$short_hash
          image="ghcr.io/cptspacemanspiff/gnome-power-display-devcontainer:$image_tag"

          exists=false
          if docker manifest inspect "$image" > /dev/null 2>&1; then
            exists=true
          fi

          should_build=false
          if [ "${{ steps.filter.outputs.devcontainer }}" = "true" ] || [ "$exists" != "true" ]; then
            should_build=true
          fi

          echo "devcontainer_hash=$short_hash" >> "$GITHUB_OUTPUT"
          echo "image_tag=$image_tag" >> "$GITHUB_OUTPUT"
          echo "prebuilt_exists=$exists" >> "$GITHUB_OUTPUT"
          echo "should_build=$should_build" >> "$GITHUB_OUTPUT"

      - name: Generate hash-pinned CI devcontainer config
        run: |
          mkdir -p .devcontainer/ci-generated
          cat > .devcontainer/ci-generated/devcontainer.json <<EOF
          {
            "name": "GNOME Power Display CI",
            "image": "ghcr.io/cptspacemanspiff/gnome-power-display-devcontainer:${{ steps.prep.outputs.image_tag }}",
            "remoteUser": "vscode"
          }
          EOF

      - name: Build devcontainer image when needed
        if: steps.prep.outputs.should_build == 'true'
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/devcontainer.json
          imageName: ghcr.io/cptspacemanspiff/gnome-power-display-devcontainer
          imageTag: ${{ steps.prep.outputs.image_tag }},latest
          cacheFrom: ghcr.io/cptspacemanspiff/gnome-power-display-devcontainer
          push: filter
          refFilterForPush: refs/heads/main
          eventFilterForPush: push

      - name: Run Bazel checks in hash-pinned devcontainer
        uses: devcontainers/ci@v0.3
        with:
          configFile: .devcontainer/ci-generated/devcontainer.json
          push: never
          runCmd: |
            bazel test //...
            bazel build //cmd/power-monitor-daemon //cmd/power-calibrate
